<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Constraints Programming</title>
  </head>
  <body>
    <h1>Constraint Programming Course Scheduler</h1>
    <a
      href="https://en.wikipedia.org/wiki/Constraint_programming"
      target="_blank"
    >
      Constraint programming is awesome
    </a>

    <br />

    <h3>Available Courses</h3>
    <ul id="courseList">
      <li draggable="true">Math 101</li>
      <li draggable="true">Physics 101</li>
      <li draggable="true">Chemistry 101</li>
      <li draggable="true">Biology 101</li>
      <li draggable="true">History 101</li>
    </ul>

    <br />

    <h3>Semesters</h3>
    <table border="1">
      <tr>
        <td
          class="semester"
          data-semester="1"
          width="150"
          height="100"
          valign="top"
          align="center"
        >
          <b>Sum 2025</b>
        </td>
        <td
          class="semester"
          data-semester="2"
          width="150"
          height="100"
          valign="top"
          align="center"
        >
          <b>Aut 2026</b>
        </td>
        <td
          class="semester"
          data-semester="3"
          width="150"
          height="100"
          valign="top"
          align="center"
        >
          <b>Win 2026</b>
        </td>
        <td
          class="semester"
          data-semester="4"
          width="150"
          height="100"
          valign="top"
          align="center"
        >
          <b>Spr 2026</b>
        </td>
        <td
          class="semester"
          data-semester="5"
          width="150"
          height="100"
          valign="top"
          align="center"
        >
          <b>Sum 2026</b>
        </td>
      </tr>
    </table>

    <br />

    <h3>Verify</h3>
    <button onclick="validate()">Go!</button>
    <div id="verificationResult">Score: N/A</div>

    <br />

    <h3>Assumptions</h3>
    <ul>
      <li>Courses are either "bludge" or "hard"</li>
    </ul>

    <br />

    <h3>Constraints</h3>

    <table border="1">
      <thead>
        <tr>
          <th>Code</th>
          <th>Specification</th>
          <th>Source</th>
          <th>Priority</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>C1</td>
          <td>Must do exactly 6 subjects in total</td>
          <td>UTS Requirement</td>
          <td>High</td>
        </tr>
        <tr>
          <td>C2</td>
          <td>Can only take a subject if it is offered in that semester</td>
          <td>UTS Requirement</td>
          <td>High</td>
        </tr>
        <tr>
          <td>C3</td>
          <td>Cannot take a subject more than once</td>
          <td>UTS Requirement</td>
          <td>High</td>
        </tr>
        <tr>
          <td>C4</td>
          <td>
            In Sum 2025 and Aut 2026 no more than 2 bludge subjects can be
            taken, and no hard subjects can be taken
          </td>
          <td>Due to Rover commitments</td>
          <td>Medium</td>
        </tr>
        <tr>
          <td>C5</td>
          <td>
            Can only do a subject after any prerequisites have been completed
          </td>
          <td>UTS Requirement</td>
          <td>Medium</td>
        </tr>
        <tr>
          <td>C6</td>
          <td>Either DDD or Math2 must be taken</td>
          <td>Wtg/UTS Requirement</td>
          <td>High</td>
        </tr>
      </tbody>
    </table>

    <br />

    <p>Given these constraints, maximize the following function:</p>
    <ul>
      <li>f(x) = |H|, where H is the number of hard subjects taken</li>
    </ul>

    <script type="module">
      const semesters = document.querySelectorAll(".semester");
      const semesterCells = Array.from(document.querySelectorAll(".semester"));

      semesters.forEach((sem) => {
        sem.addEventListener("dragover", (e) => {
          e.preventDefault();
        });

        sem.addEventListener("drop", (e) => {
          e.preventDefault();
          const data = e.dataTransfer.getData("text");
          const newItem = document.createElement("div");
          newItem.textContent = data;
          sem.appendChild(newItem);
        });
      });

      const fetchData = async () => {
        const response = await fetch("./data.json");
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      };

      const data = await fetchData();
      const nicknameToCourse = {};
      data.forEach((course) => {
        nicknameToCourse[course.nickname] = course;
      });

      console.log(data);
      const courseList = document.getElementById("courseList");

      courseList.innerHTML = "";

      data.forEach((course) => {
        const li = document.createElement("li");
        li.textContent = course.nickname;
        li.setAttribute("draggable", "true");
        courseList.appendChild(li);
      });

      const courses = document.querySelectorAll("#courseList li");

      courses.forEach((course) => {
        course.addEventListener("dragstart", (e) => {
          e.dataTransfer.setData("text", e.target.textContent);
        });
      });

      const noDuplicates = () => {
        const subjectDivs = document.querySelectorAll(".semester div");
        const subjects = Array.from(subjectDivs).map((div) =>
          div.textContent.trim()
        );

        return new Set(subjects).size === subjects.length;
      };

      const totalSixSubjects = () => {
        const subjectDivs = document.querySelectorAll(".semester div");
        return subjectDivs.length === 6;
      };

      const prerequisitesMet = () => {
        const completedCourses = new Set();

        for (let sem of semesterCells) {
          const completedInThisSem = new Set();
          const subjects = Array.from(sem.querySelectorAll("div")).map((div) =>
            div.textContent.trim()
          );

          for (let subject of subjects) {
            const course = nicknameToCourse[subject];
            if (!course) continue;

            const unmet = course.prerequisites.filter(
              (code) => !completedCourses.has(code)
            );
            if (unmet.length > 0) {
              return false;
            }

            completedInThisSem.add(course.code);
          }
          for (let code of completedInThisSem) {
            completedCourses.add(code);
          }
        }

        return true;
      };

      const subjectsOfferedInSemester = () => {
        for (let sem of semesterCells) {
          const semesterName = sem.querySelector("b")?.textContent.trim();
          if (!semesterName) continue;

          const subjects = Array.from(sem.querySelectorAll("div")).map((div) =>
            div.textContent.trim()
          );

          for (let subject of subjects) {
            const course = nicknameToCourse[subject];
            if (!course) continue;

            if (!course.semesters.includes(semesterName)) {
              return false;
            }
          }
        }

        return true;
      };

      const statisticsRequirement = () => {
        for (let sem of semesterCells) {
          const subjects = Array.from(sem.querySelectorAll("div")).map((div) =>
            div.textContent.trim()
          );

          if (subjects.includes("DDD") || subjects.includes("Math2")) {
            return true;
          }
        }

        return false;
      };

      const checkBludgeConstraint = () => {
        for (let sem of semesterCells) {
          const semesterName = sem.querySelector("b")?.textContent.trim();
          if (!semesterName) continue;

          if (semesterName === "Sum 2025" || semesterName === "Aut 2026") {
            const subjects = Array.from(sem.querySelectorAll("div")).map(
              (div) => div.textContent.trim()
            );

            let bludgeCount = 0;

            for (let subject of subjects) {
              const course = nicknameToCourse[subject];
              if (!course) continue;

              if (course.difficulty === "hard") {
                return false;
              }

              if (course.difficulty === "bludge") {
                bludgeCount++;
              }
            }

            if (bludgeCount > 2) {
              return false;
            }
          }
        }

        return true;
      };

      const constraints = [
        { check: noDuplicates, error: "Cannot take a subject more than once" },
        {
          check: prerequisitesMet,
          error: "Prerequisites not satisfied for some subjects",
        },
        {
          check: subjectsOfferedInSemester,
          error: "Some subjects are not offered in the selected semester",
        },
        {
          check: checkBludgeConstraint,
          error:
            "Sum 2025 and Aut 2026 must have less than or equal to 2 bludge subjects and no hard subjects",
        },
        {
          check: totalSixSubjects,
          error: "Must do exactly 6 subjects in total",
        },
        {
          check: statisticsRequirement,
          error: "Either DDD or Math2 must be taken",
        },
      ];

      window.validate = () => {
        console.log("Validating selections...");
        const errors = [];

        for (const constraint of constraints) {
          if (!constraint.check()) {
            errors.push(constraint.error);
          }
        }

        if (errors.length === 0) {
          alert("All constraints satisfied!");
        } else {
          alert("Constraint violations:\n- " + errors.join("\n- "));
        }

        console.log("Errors", errors);

        const newScore = Math.floor(Math.random() * 101);
        document.getElementById("verificationResult").textContent =
          "Score (this is random rn): " + newScore + "%";
      };
    </script>
  </body>
</html>
